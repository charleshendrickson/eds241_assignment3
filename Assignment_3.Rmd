---
title: "EDS241: Assignment 3"
author: "Charles Hendrickson"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
--- 

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)


# load packages
packages=c("stargazer", "here", "tidyr", "dplyr","stringr", "janitor", 
           "cowplot", "ggplot2", "tinytex", "datasets", "tibble", "openxlsx", "estimatr", "car", "readxl")

# Load estimatr package
library(estimatr)

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

#devtools::install_github('rstudio/rmarkdown')
options(scipen=10) # not scientific notation

```

Load the SMOKING_EDS241.csv data 
```{r}
# load data 
smoking_data <- read.csv("SMOKING_EDS241.csv")

```

\noindent (a) What is the unadjusted mean difference in birth weight of infants with smoking and nonsmoking mothers? Under what assumption does this correspond to the average treatment effect of maternal smoking during pregnancy on infant birth weight? Provide some simple empirical evidence for or against this hypothesis.

For the last part of (a), I would regress your favorite covariate on the smoking status of mothers. For example, think of regressing meduc ~ tobacco. Is the mean difference in the education level of smoking and non-smoking mothers statistically different from zero? What does that say about the required assumption to interpret the unadjusted mean difference as causal? Let me know if this tip is still too cryptic.

**The unadjusted mean difference in birth weight of infants with smoking and nonsmoking mothers is -244.5 grams.**

**Under the "treatment ignorability" assumption, this corresponds to the average treatment effect of maternal smoking during pregnancy on infant birth weight**

**When regressing the mother's education level (meduc) on the indicator for maternal smoking (tobacco), the mean difference in the education level of smoking and non-smoking mothers is -1.318 grams which is statistically significant becuase the p-value < 2.2e-16, which is much lower than the 5% significance level. Therefore, we can interpret the unadjusted mean difference as causal.**


```{r}
# Regress birth weight of infant in grams (birthwgt) on the indicator for maternal smoking (tobacco)
summary(lm_robust(birthwgt ~ tobacco, data = smoking_data))
```

```{r}
# Regress the mother's education level (meduc) on the indicator for maternal smoking (tobacco)
summary(lm_robust(meduc ~ tobacco, data = smoking_data))
```

\noindent (b) Assume that maternal smoking is randomly assigned conditional on the observable covariates listed above. Estimate the effect of maternal smoking on birth weight using a linear regression. Report the estimated coefficient on tobacco and its standard error.

On (b), simply include all of the covariates linearly. We are making a functional form assumption on the linear impact of covariates on the outcome.

**The estimated coefficient on tobacco is -228.073 grams and the standard error is 4.2768.**

```{r}
summary(lm_robust(birthwgt ~ ., data = smoking_data))
```


\noindent (c) Use the exact matching estimator to estimate the effect of maternal smoking on birth weight. For simplicity, consider the following covariates in your matching estimator: create a 0-1 indicator for mother's age (=1 if mage>=34), and a 0-1 indicator for mother's education (1 if meduc>=16), mother's race (mblack), and alcohol consumption indicator (alcohol). These 4 covariates will create 2*2*2*2 = 16 cells. Report the estimated average treatment effect of smoking on birthweight using the exact matching estimator and its linear regression analogue (Lecture 6, slides 12-14).

For (c), once you have your 4 dummy variables, you can create a group variable g using the paste0() function. For example, mutate(g = paste0(d1,d2,d3,d4)) . The resulting g will include all potential observed combinations of the 4 dummy variables in the data. You can then control for factor(g) in the regression model. This is much simpler than interacting all the dummy variables as we talked about in OHs today.
For (c), to calculate the exact matching estimator, use this g grouping variable and the code from lines 76 to 97 in the TIA.R script on gauchospace. In this case, Y = birthwgt, X = g, D = tobacco. Since we observe Y1 or Y0, you can ignore line 77.

**The estimated average treatment effect of smoking on birthweight using the exact matching estimator and its linear regression analogue is -224.2583 grams.**

```{r}
# Create a new variable called "D_mage" by using "ifelse", which takes a condition, followed by what the output should be if the condition is met, followed by the output of the condition is not met.

smoking_data_dummy <- smoking_data %>% 
  mutate(D_mage = ifelse(mage >= 34, 1, 0)) %>%   # Conditional on Mother's Age 
  mutate(D_meduc = ifelse(meduc>=16, 1, 0)) %>%   # Conditional on Mother's Education
  mutate(D_mblack = ifelse(mblack == 1, 1, 0)) %>%
  mutate(D_alcohol = ifelse(alcohol == 1, 1, 0)) %>% 
  mutate(g = paste0(D_mage,D_meduc,D_mblack,D_alcohol))

summary(lm_robust(birthwgt ~ tobacco + factor(g), data = smoking_data_dummy))

```

```{r}
TIA_table <- smoking_data_dummy %>%
  group_by(g, tobacco)%>% 
  summarise(n_obs = n(),
            Y_mean= mean(birthwgt, na.rm = T))%>% #Calculate number of observations and Y mean by X by treatment cells
  gather(variables, values, n_obs:Y_mean)%>% #Reshape data
  mutate(variables = paste0(variables,"_",tobacco, sep=""))%>% #Combine the treatment and variables for reshaping
  pivot_wider(id_cols = g, names_from = variables,values_from = values)%>% #Reshape data by treatment and X cell
  ungroup()%>%  #Ungroup from X values
  mutate(Y_diff = Y_mean_1 - Y_mean_0, #calculate Y_diff
         w_ATE = (n_obs_0+n_obs_1)/(sum(n_obs_0)+sum(n_obs_1)),
         w_ATT = n_obs_1/sum(n_obs_1))%>% #calculate weights
  mutate_if(is.numeric, round, 2) #Round data


stargazer(TIA_table, type= "text", summary = FALSE, digits = 2)

# MULTIVARIATE MATCHING ESTIMATES OF ATE AND ATT
ATE=sum((TIA_table$w_ATE)*(TIA_table$Y_diff))
ATE
ATT=sum((TIA_table$w_ATT)*(TIA_table$Y_diff))
ATT

```


(d) Estimate the propensity score for maternal smoking using a logit estimator and based on the following specification: mother’s age, mother’s age squared, mother’s education, and indicators for mother’s race, and alcohol consumption. 

```{r}
# Create a 'mother's age squared' variable in the smoking_data_dummy
smoking_data_dummy <- smoking_data_dummy %>% 
  mutate(mage_squared = mage*mage)
```


```{r}
# Estimate the propensity score model and predict (EPS)
ps_model <- glm(formula = tobacco ~ mage + mage_squared + meduc + D_mblack + D_alcohol, family = binomial(), data = smoking_data_dummy)

summary(ps_model)
EPS <- predict(ps_model, type = "response")
PS_WGT <- (smoking_data_dummy$tobacco/EPS) + ((1-smoking_data_dummy$tobacco)/(1-EPS))
```

**The propensity scores are??**

(e) Use the propensity score weighted regression (WLS) to estimate the effect of maternal smoking on birth weight (Lecture 7, slide 12).


```{r}
# COLLECT ALL RELEVANT VARIABLES IN DATAFRAME
DF <- data.frame(years = CGL$years, collapse = CGL$collapse, DAPever = CGL$DAPever, 
                 LME = CGL$LME, genus = CGL$genus, species = CGL$species, EPS, PS_WGT)
```

```{r}
# propensity score weighted regression (WLS)
wls1 <- lm(formula = collapse ~ DAPever, data=DF, weights=PS_WGT)
wls2 <- lm(formula = collapse ~ DAPever + LME + genus, data=DF, weights=PS_WGT)
se_models = starprep(wls1, wls2, stat = c("std.error"), se_type = "HC2", alpha = 0.05)
stargazer(wls1, wls2, se = se_models, type="text", omit = "(LME)|(genus)|(species)")
```

































